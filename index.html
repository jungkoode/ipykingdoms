<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Twin Kingdoms of Aurenne and Daeryndor - Mobile Interactive Map</title>

```
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<!-- Additional Libraries -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

<!-- Google Fonts for medieval aesthetic -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&family=MedievalSharp&display=swap" rel="stylesheet">

<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Crimson Text', serif;
        background: linear-gradient(135deg, #8B4513, #D2B48C);
        overflow: hidden;
        position: relative;
        touch-action: manipulation;
    }

    /* Mobile-First Particles Background */
    #particles-js {
        position: absolute;
        width: 100%;
        height: 100%;
        z-index: 1;
        pointer-events: none;
    }

    #map {
        width: 100vw;
        height: 100vh;
        background: #f4f1e8;
        position: relative;
        z-index: 2;
        transition: all 0.8s ease;
    }

    /* Era-based visual changes */
    .era-ancient { 
        filter: sepia(0.8) brightness(0.7) contrast(1.2) hue-rotate(30deg);
    }
    .era-war { 
        filter: sepia(0.6) brightness(0.6) contrast(1.4) hue-rotate(350deg) saturate(1.5);
    }
    .era-peace { 
        filter: sepia(0.3) brightness(0.85) contrast(1.1) hue-rotate(10deg);
    }
    .era-modern { 
        filter: sepia(0.1) brightness(0.95) contrast(1.05);
    }
    .era-current { 
        filter: none;
    }

    /* Mobile-optimized title */
    .map-title {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: linear-gradient(135deg, rgba(139, 69, 19, 0.95), rgba(101, 67, 33, 0.95));
        color: #f4f1e8;
        padding: 8px 16px;
        border-radius: 8px;
        border: 2px solid #D4AF37;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        font-family: 'Cinzel', serif;
        font-size: 0.9rem;
        font-weight: 700;
        text-align: center;
        letter-spacing: 1px;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        max-width: calc(100% - 20px);
    }

    /* Mobile-first search control */
    .search-control {
        position: absolute;
        top: 50px;
        left: 10px;
        right: 10px;
        z-index: 1000;
        background: linear-gradient(135deg, rgba(139, 69, 19, 0.95), rgba(101, 67, 33, 0.95));
        padding: 8px 12px;
        border-radius: 20px;
        border: 2px solid #D4AF37;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .search-control input {
        background: rgba(244, 241, 232, 0.9);
        border: 1px solid #D4AF37;
        border-radius: 12px;
        padding: 8px 12px;
        font-family: 'Crimson Text', serif;
        width: 100%;
        color: #2F4F4F;
        font-size: 14px;
    }

    .search-control input:focus {
        outline: none;
        border-color: #FFD700;
        box-shadow: 0 0 5px rgba(212, 175, 55, 0.5);
    }

    .search-control i {
        color: #D4AF37;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    /* Mobile-optimized control panel */
    .control-panel {
        position: absolute;
        bottom: 80px;
        left: 10px;
        right: 10px;
        background: linear-gradient(135deg, rgba(139, 69, 19, 0.95), rgba(101, 67, 33, 0.95));
        border: 2px solid #D4AF37;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        max-height: 50vh;
        overflow-y: auto;
        backdrop-filter: blur(5px);
    }

    .panel-tabs {
        display: flex;
        border-bottom: 2px solid #D4AF37;
        background: rgba(101, 67, 33, 0.8);
    }

    .panel-tab {
        flex: 1;
        padding: 12px 4px;
        color: #f4f1e8;
        text-align: center;
        cursor: pointer;
        font-family: 'Cinzel', serif;
        font-weight: 600;
        font-size: 0.75rem;
        border-right: 1px solid #D4AF37;
        transition: all 0.3s ease;
        min-height: 44px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 2px;
    }

    .panel-tab:last-child {
        border-right: none;
    }

    .panel-tab.active {
        background: linear-gradient(135deg, #D4AF37, #FFD700);
        color: #2F4F4F;
        text-shadow: none;
    }

    .panel-tab i {
        font-size: 1rem;
    }

    .panel-content {
        padding: 15px;
        color: #f4f1e8;
        display: none;
        font-size: 0.9rem;
        line-height: 1.5;
    }

    .panel-content.active {
        display: block;
    }

    .panel-content h3 {
        font-family: 'Cinzel', serif;
        color: #D4AF37;
        margin-bottom: 10px;
        font-size: 1.1rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .panel-content p {
        margin-bottom: 10px;
        line-height: 1.5;
    }

    /* Mobile-optimized timeline */
    .timeline-control {
        position: absolute;
        bottom: 10px;
        left: 10px;
        right: 10px;
        background: linear-gradient(135deg, rgba(139, 69, 19, 0.95), rgba(101, 67, 33, 0.95));
        border: 2px solid #D4AF37;
        border-radius: 20px;
        padding: 12px 16px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .timeline-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #f4f1e8;
        font-family: 'Cinzel', serif;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .timeline-slider {
        width: 100%;
        height: 8px;
        background: linear-gradient(90deg, #654321, #8B4513, #654321);
        border-radius: 4px;
        position: relative;
        cursor: pointer;
    }

    .timeline-handle {
        width: 20px;
        height: 20px;
        background: radial-gradient(circle, #D4AF37, #FFD700);
        border: 2px solid #B8860B;
        border-radius: 50%;
        position: absolute;
        top: -6px;
        cursor: grab;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
        transition: transform 0.2s ease;
    }

    .timeline-handle:active {
        cursor: grabbing;
        transform: scale(1.1);
    }

    .era-description {
        text-align: center;
        color: #D4AF37;
        font-size: 0.8rem;
        font-style: italic;
    }

    /* Mobile-optimized markers */
    .custom-marker {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        transition: all 0.3s ease;
        cursor: pointer;
        font-size: 1.4rem;
        position: relative;
    }

    .custom-marker:hover, .custom-marker:active {
        transform: scale(1.15);
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.7);
    }

    /* Era-specific marker visibility and styling */
    .era-ancient .custom-marker:not(.ancient-era) {
        opacity: 0.3;
        filter: grayscale(0.8);
    }

    .era-war .custom-marker:not(.war-era) {
        opacity: 0.4;
        filter: grayscale(0.6) sepia(0.3);
    }

    .era-peace .custom-marker:not(.peace-era) {
        opacity: 0.5;
        filter: grayscale(0.4);
    }

    .era-modern .custom-marker:not(.modern-era) {
        opacity: 0.6;
        filter: grayscale(0.2);
    }

    .era-current .custom-marker {
        opacity: 1;
        filter: none;
    }

    .aurenne-marker {
        background: radial-gradient(circle, #DAA520, #FFD700, #B8860B);
        border-color: #B8860B;
        animation: golden-pulse 4s ease-in-out infinite;
    }

    .daeryndor-marker {
        background: radial-gradient(circle, #2F4F4F, #708090, #1C1C1C);
        border-color: #1C1C1C;
        animation: silver-pulse 4s ease-in-out infinite;
    }

    .border-marker {
        background: radial-gradient(circle, #8B4513, #D2B48C, #654321);
        border-color: #654321;
        animation: neutral-pulse 4s ease-in-out infinite;
    }

    /* Era indicators on markers */
    .custom-marker::before {
        content: '';
        position: absolute;
        top: -2px;
        right: -2px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 1px solid white;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .ancient-era::before { background: #8B4513; }
    .war-era::before { background: #DC143C; }
    .peace-era::before { background: #32CD32; }
    .modern-era::before { background: #4169E1; }

    .era-ancient .ancient-era::before,
    .era-war .war-era::before,
    .era-peace .peace-era::before,
    .era-modern .modern-era::before {
        opacity: 1;
    }

    @keyframes golden-pulse {
        0%, 100% { box-shadow: 0 4px 12px rgba(218, 165, 32, 0.5); }
        50% { box-shadow: 0 6px 20px rgba(255, 215, 0, 0.9); }
    }

    @keyframes silver-pulse {
        0%, 100% { box-shadow: 0 4px 12px rgba(47, 79, 79, 0.5); }
        50% { box-shadow: 0 6px 20px rgba(112, 128, 144, 0.9); }
    }

    @keyframes neutral-pulse {
        0%, 100% { box-shadow: 0 4px 12px rgba(139, 69, 19, 0.5); }
        50% { box-shadow: 0 6px 20px rgba(210, 180, 140, 0.9); }
    }

    /* Mobile-optimized relationship lines */
    .relationship-line {
        stroke-width: 4;
        stroke-dasharray: 8, 4;
        animation: dash 2s linear infinite;
        filter: drop-shadow(0 0 4px rgba(0, 0, 0, 0.4));
        transition: all 0.5s ease;
    }

    /* Era-specific relationship line styling */
    .era-ancient .relationship-line {
        stroke-width: 2;
        opacity: 0.3;
        stroke-dasharray: 15, 5;
    }

    .era-war .relationship-line {
        stroke-width: 6;
        opacity: 0.8;
        stroke-dasharray: 3, 3;
        animation: dash 0.5s linear infinite;
    }

    .era-peace .relationship-line {
        stroke-width: 3;
        opacity: 0.6;
        stroke-dasharray: 10, 5;
    }

    .era-modern .relationship-line {
        stroke-width: 4;
        opacity: 0.7;
        stroke-dasharray: 8, 4;
    }

    .era-current .relationship-line {
        stroke-width: 4;
        opacity: 0.8;
        stroke-dasharray: 8, 4;
    }

    @keyframes dash {
        to { stroke-dashoffset: -20; }
    }

    /* Mobile-optimized popups */
    .leaflet-popup-content-wrapper {
        background: linear-gradient(135deg, rgba(139, 69, 19, 0.98), rgba(101, 67, 33, 0.98));
        color: #f4f1e8;
        border: 2px solid #D4AF37;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        max-width: calc(100vw - 40px) !important;
    }

    .leaflet-popup-content {
        margin: 15px;
        font-family: 'Crimson Text', serif;
        line-height: 1.5;
        font-size: 0.9rem;
    }

    .popup-header {
        font-family: 'Cinzel', serif;
        color: #D4AF37;
        margin-bottom: 10px;
        font-size: 1.2rem;
        font-weight: 700;
        text-align: center;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        border-bottom: 2px solid #D4AF37;
        padding-bottom: 6px;
    }

    .popup-section {
        margin: 10px 0;
        padding: 8px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        border-left: 3px solid #D4AF37;
    }

    .popup-section h4 {
        color: #FFD700;
        font-family: 'Cinzel', serif;
        margin-bottom: 4px;
        font-size: 0.95rem;
    }

    .expand-btn, .action-btn {
        background: linear-gradient(135deg, #D4AF37, #FFD700);
        border: none;
        padding: 10px 16px;
        border-radius: 20px;
        color: #2F4F4F;
        font-family: 'Cinzel', serif;
        font-weight: 600;
        cursor: pointer;
        margin: 4px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        min-height: 44px;
        font-size: 0.9rem;
    }

    .expand-btn:active, .action-btn:active {
        background: linear-gradient(135deg, #FFD700, #FFF8DC);
        transform: translateY(1px);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    /* Achievement notification */
    .achievement-notification {
        position: absolute;
        top: 90px;
        left: 10px;
        right: 10px;
        background: linear-gradient(135deg, #D4AF37, #FFD700);
        color: #2F4F4F;
        padding: 12px 16px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        z-index: 1001;
        transform: translateY(-120%);
        transition: transform 0.5s ease;
        font-family: 'Cinzel', serif;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .achievement-notification.show {
        transform: translateY(0);
    }

    .achievement-icon {
        font-size: 1.3rem;
        margin-right: 8px;
    }

    /* Loading animation */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #8B4513, #D2B48C);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        transition: opacity 0.8s ease;
    }

    .loading-text {
        font-family: 'Cinzel', serif;
        font-size: 1.8rem;
        color: #f4f1e8;
        text-align: center;
        animation: loading-pulse 2s infinite;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        padding: 0 20px;
    }

    .loading-progress {
        width: calc(100% - 40px);
        max-width: 300px;
        height: 6px;
        background: rgba(244, 241, 232, 0.3);
        border-radius: 3px;
        overflow: hidden;
    }

    .loading-bar {
        height: 100%;
        background: linear-gradient(90deg, #D4AF37, #FFD700, #D4AF37);
        animation: loading-bar 2s ease-in-out infinite;
    }

    @keyframes loading-pulse {
        0%, 100% { opacity: 0.7; }
        50% { opacity: 1; }
    }

    @keyframes loading-bar {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(400px); }
    }

    /* Discovery effects */
    .discovery-glow {
        animation: discovery-pulse 3s ease-in-out;
    }

    @keyframes discovery-pulse {
        0%, 100% { filter: brightness(1) drop-shadow(0 0 8px rgba(212, 175, 55, 0.4)); }
        50% { filter: brightness(1.4) drop-shadow(0 0 20px rgba(255, 215, 0, 1)); }
    }

    /* Custom scrollbar for mobile */
    .control-panel::-webkit-scrollbar {
        width: 6px;
    }

    .control-panel::-webkit-scrollbar-track {
        background: rgba(101, 67, 33, 0.3);
        border-radius: 3px;
    }

    .control-panel::-webkit-scrollbar-thumb {
        background: #D4AF37;
        border-radius: 3px;
    }

    .leaflet-popup-tip {
        background: linear-gradient(135deg, rgba(139, 69, 19, 0.98), rgba(101, 67, 33, 0.98));
        border: 2px solid #D4AF37;
    }

    .leaflet-popup-close-button {
        color: #D4AF37 !important;
        font-size: 20px !important;
        font-weight: bold !important;
        width: 24px !important;
        height: 24px !important;
    }

    /* Touch-friendly controls */
    .leaflet-control-zoom a {
        width: 36px !important;
        height: 36px !important;
        line-height: 36px !important;
        font-size: 18px !important;
    }

    /* Ensure proper touch handling */
    .leaflet-container {
        touch-action: pan-x pan-y;
    }
</style>
```

</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-text">
            Conjuring the Royal Realms...
            <br>
            <small style="font-family: 'Crimson Text', serif; font-size: 1rem;">Prepare for an epic journey</small>
        </div>
        <div class="loading-progress">
            <div class="loading-bar"></div>
        </div>
    </div>

```
<!-- Particles Background -->
<div id="particles-js"></div>

<div class="map-title">
    ⚜️ The Twin Kingdoms ⚜️
</div>

<div class="search-control">
    <i class="fas fa-search"></i>
    <input type="text" id="searchInput" placeholder="Search locations, characters, lore..." />
</div>

<div id="map"></div>

<!-- Mobile-optimized Control Panel -->
<div class="control-panel">
    <div class="panel-tabs">
        <div class="panel-tab active" data-tab="lore">
            <i class="fas fa-scroll"></i>
            <span>Lore</span>
        </div>
        <div class="panel-tab" data-tab="characters">
            <i class="fas fa-users"></i>
            <span>Court</span>
        </div>
        <div class="panel-tab" data-tab="quests">
            <i class="fas fa-compass"></i>
            <span>Quests</span>
        </div>
        <div class="panel-tab" data-tab="achievements">
            <i class="fas fa-trophy"></i>
            <span>Honors</span>
        </div>
    </div>

    <div class="panel-content active" id="lore-content">
        <h3>Kingdom Lore</h3>
        <p>Tap a location to uncover its secrets and discover the rich history of the Twin Kingdoms.</p>
        <div id="location-details">
            <p><em>The winds whisper tales of ancient alliances and forbidden love...</em></p>
        </div>
    </div>

    <div class="panel-content" id="characters-content">
        <h3>Royal Court</h3>
        <div id="character-list">
            <div class="popup-section">
                <h4>👑 House of Daeryndor</h4>
                <p><strong>Prince Seokjin:</strong> "The Ivory Prince" - Known for his stoic demeanor and scholarly pursuits.</p>
                <p><strong>Prince Namjoon:</strong> Master of Archives, secret progressive thinker.</p>
            </div>
            <div class="popup-section">
                <h4>🌟 House of Aurenne</h4>
                <p><strong>Princess Y/N:</strong> "The Vermillion Rose" - Now Crown Princess of Daeryndor.</p>
                <p><strong>Princess Elise:</strong> Talented artist and Y/N's beloved sister.</p>
            </div>
        </div>
    </div>

    <div class="panel-content" id="quests-content">
        <h3>Royal Quests</h3>
        <div id="quest-log">
            <div class="popup-section">
                <h4>⚡ Active Quests</h4>
                <p><strong>Royal Introduction:</strong> Visit both capital cities</p>
                <p><strong>Border Mysteries:</strong> Investigate Storeward</p>
                <p><strong>Scholarly Pursuit:</strong> Explore Iroholor's secrets</p>
            </div>
        </div>
    </div>

    <div class="panel-content" id="achievements-content">
        <h3>Royal Honors</h3>
        <div id="achievement-list">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Mobile Timeline Control -->
<div class="timeline-control">
    <div class="timeline-info">
        <i class="fas fa-history"></i>
        <div id="timeline-label">Current Era</div>
        <i class="fas fa-forward"></i>
    </div>
    <div class="timeline-slider" id="timeline-slider">
        <div class="timeline-handle" id="timeline-handle"></div>
    </div>
    <div class="era-description" id="era-description">The Royal Alliance</div>
</div>

<!-- Achievement Notification -->
<div class="achievement-notification" id="achievement-notification">
    <span class="achievement-icon">🏆</span>
    <span id="achievement-text">Achievement Unlocked!</span>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/particles.js/2.0.0/particles.min.js"></script>

<script>
    // Enhanced Kingdom Data with Era Information
    const kingdomData = {
        'Caelforge': {
            coords: [720, 200],
            kingdom: 'Daeryndor',
            type: 'Capital',
            ruler: 'Prince Seokjin "The Ivory Prince"',
            description: 'The mighty capital of Daeryndor, carved into the living rock of Mount Kaelros. Ancient granite walls have witnessed centuries of royal intrigue.',
            population: '150,000',
            features: ['Royal Palace Complex', 'The Great Library', 'Mountain Fortress', 'Royal Archives'],
            secrets: ['Hidden passages beneath the throne room', 'The Ivory Prince\'s private study', 'Secret midnight meetings in the Rose Garden'],
            characters: ['Prince Seokjin', 'Princess Y/N (after marriage)', 'Commander Hoseok', 'Grand Minister Yoongi'],
            lore: 'Legend speaks of the Moonlit Pact, signed here three centuries ago, that first bound the kingdoms in an uneasy peace.',
            relationships: ['Political alliance with Ironroud', 'Tense border with Storeward', 'Ancient rivalry with Solaire'],
            quests: ['Discover the secret of the Ivory Tower', 'Uncover the truth behind the Royal Archives'],
            discovered: false,
            weather: 'snow',
            // Era information
            eras: {
                ancient: { existed: true, name: 'Stone Keep', description: 'A simple mountain fortress guarding the northern passes' },
                war: { existed: true, name: 'War Citadel', description: 'Heavily fortified during the Great Kingdom Wars' },
                peace: { existed: true, name: 'Royal Seat', description: 'Expanded into a proper royal palace' },
                modern: { existed: true, name: 'Capital City', description: 'Grew into the magnificent capital we know today' },
                current: { existed: true, name: 'Caelforge', description: 'The mighty capital of Daeryndor' }
            }
        },
        'Solaire': {
            coords: [300, 550],
            kingdom: 'Aurenne',
            type: 'Capital',
            ruler: 'King Alaric & Queen Eleanora',
            description: 'The golden capital of Aurenne, where the sun never seems to set on the terraced palaces.',
            population: '200,000',
            features: ['Palace of Golden Towers', 'The Hall of Mirrors', 'Royal Gardens', 'Azure Harbor'],
            secrets: ['Princess Y/N\'s hidden diary', 'Secret harbor tunnels', 'The Queen\'s spy network'],
            characters: ['King Alaric', 'Queen Eleanora', 'Princess Y/N (before marriage)', 'Princess Elise'],
            lore: 'The Azure Crown, worn only by Aurenne queens, is said to grant visions of true love.',
            relationships: ['Strained alliance with Caelforge', 'Trade partnership with Lucastel'],
            quests: ['Find Princess Y/N\'s lost letters', 'Explore the Royal Gardens maze'],
            discovered: false,
            weather: 'golden',
            eras: {
                ancient: { existed: false, name: 'The Void', description: 'This land was uninhabited wilderness' },
                war: { existed: true, name: 'Golden Haven', description: 'Founded as a refuge during the wars' },
                peace: { existed: true, name: 'Rising City', description: 'Rapidly grew into a major settlement' },
                modern: { existed: true, name: 'Royal Capital', description: 'Became the seat of Aurenne power' },
                current: { existed: true, name: 'Solaire', description: 'The golden capital of Aurenne' }
            }
        },
        'Frosthaven': {
            coords: [850, 120],
            kingdom: 'Daeryndor',
            type: 'Settlement',
            ruler: 'Lord Commander Jungkook\'s Family',
            description: 'A hardy northern settlement where silver flows like water and craftsmen forge legends in steel.',
            population: '25,000',
            features: ['The Silver Depths', 'Master Forges', 'Watchtower Keep'],
            secrets: ['Ancient dwarven ruins beneath', 'Secret training grounds'],
            characters: ['Mining Guild Masters', 'Elite Guard Trainees'],
            lore: 'The silver mined here created the wedding rings for the royal alliance.',
            relationships: ['Supply route to Caelforge'],
            quests: ['Investigate mysterious silver veins'],
            discovered: false,
            weather: 'snow',
            eras: {
                ancient: { existed: true, name: 'Old Mine', description: 'Ancient dwarven mining operation' },
                war: { existed: true, name: 'War Supply', description: 'Crucial source of weapons and armor' },
                peace: { existed: true, name: 'Silver Town', description: 'Peaceful mining community' },
                modern: { existed: true, name: 'Craft Center', description: 'Renowned for master craftsmen' },
                current: { existed: true, name: 'Frosthaven', description: 'Hardy northern settlement' }
            }
        },
        'Ironroud': {
            coords: [800, 400],
            kingdom: 'Daeryndor',
            type: 'Settlement',
            ruler: 'Captain Marcus Steelwind',
            description: 'The great mountain pass where two kingdoms meet and ancient agreements are honored.',
            population: '15,000',
            features: ['The Iron Gates', 'Neutral Trading Post', 'Diplomatic Quarters'],
            secrets: ['Hidden treaty vault', 'Spy network headquarters'],
            characters: ['Diplomatic Envoys', 'Border Guards'],
            lore: 'The Iron Crown Compact was signed here, establishing rules for royal marriages.',
            relationships: ['Strategic partnership with both capitals'],
            quests: ['Decode ancient diplomatic messages'],
            discovered: false,
            weather: 'mist',
            eras: {
                ancient: { existed: true, name: 'The Pass', description: 'Natural mountain gateway between lands' },
                war: { existed: true, name: 'Blood Pass', description: 'Site of countless battles and sieges' },
                peace: { existed: true, name: 'Treaty Gate', description: 'Where the first peace accords were signed' },
                modern: { existed: true, name: 'Trade Hub', description: 'Became a center of commerce' },
                current: { existed: true, name: 'Ironroud', description: 'Neutral ground between kingdoms' }
            }
        },
        'Storeward': {
            coords: [620, 180],
            kingdom: 'Border Region',
            type: 'Settlement',
            ruler: 'Neutral Council',
            description: 'A town caught between worlds, where cultures blend and love knows no borders.',
            population: '12,000',
            features: ['The Neutral Inn', 'Mixed Heritage Quarter', 'Border Market'],
            secrets: ['Underground resistance network', 'Hidden romantic meeting places'],
            characters: ['Mixed-heritage families', 'Cross-border lovers'],
            lore: 'The annual Unity Festival celebrates love that transcends borders.',
            relationships: ['Haven for star-crossed lovers'],
            quests: ['Help reunite separated lovers'],
            discovered: false,
            weather: 'variable',
            eras: {
                ancient: { existed: false, name: 'Wasteland', description: 'Disputed no-man\'s land' },
                war: { existed: false, name: 'Battleground', description: 'Constantly changing hands in warfare' },
                peace: { existed: true, name: 'Refuge Camp', description: 'Shelter for war refugees' },
                modern: { existed: true, name: 'Border Town', description: 'Grew into a permanent settlement' },
                current: { existed: true, name: 'Storeward', description: 'Neutral territory between kingdoms' }
            }
        },
        'Lucastel': {
            coords: [370, 320],
            kingdom: 'Aurenne',
            type: 'Settlement',
            ruler: 'Vintner Lord Jimin',
            description: 'Rolling hills adorned with golden vineyards, where the finest wines carry whispered secrets.',
            population: '30,000',
            features: ['Ancient Vineyards', 'Wine Cellars', 'Festival Grounds'],
            secrets: ['Wine cellars hide resistance meetings', 'Love letters in wine bottles'],
            characters: ['Lord Jimin', 'Master Vintners'],
            lore: 'The vintage from Princess Y/N\'s birth year waits for true love.',
            relationships: ['Primary wine supplier to royal courts'],
            quests: ['Attend the Harvest Festival'],
            discovered: false,
            weather: 'golden',
            eras: {
                ancient: { existed: false, name: 'Wild Hills', description: 'Untamed hills with wild grapes' },
                war: { existed: false, name: 'Burned Lands', description: 'Devastated by marching armies' },
                peace: { existed: true, name: 'First Vines', description: 'Pioneers planted the first vineyards' },
                modern: { existed: true, name: 'Wine Country', description: 'Became famous for fine wines' },
                current: { existed: true, name: 'Lucastel', description: 'Premier wine-producing region' }
            }
        },
        'Sunmist': {
            coords: [250, 180],
            kingdom: 'Aurenne',
            type: 'Settlement',
            ruler: 'Artist Colony Council',
            description: 'Where artists capture the eternal dance of sea and sky, and love poems are born.',
            population: '18,000',
            features: ['Artist Colony', 'Sunrise Point', 'Pearl Diving Grounds'],
            secrets: ['Hidden artist caves', 'Princess Elise\'s secret studio'],
            characters: ['Princess Elise (visitor)', 'Master Artists', 'Pearl Divers'],
            lore: 'Couples who watch seven sunrises together are blessed with eternal love.',
            relationships: ['Artistic inspiration for both kingdoms'],
            quests: ['Find the legendary Pearl of Hearts'],
            discovered: false,
            weather: 'misty',
            eras: {
                ancient: { existed: true, name: 'Fish Village', description: 'Simple fishing community' },
                war: { existed: true, name: 'Hidden Harbor', description: 'Secret refuge for fleeing artists' },
                peace: { existed: true, name: 'Art Haven', description: 'Artists began gathering here' },
                modern: { existed: true, name: 'Colony', description: 'Became famous artist destination' },
                current: { existed: true, name: 'Sunmist', description: 'Renowned artist colony' }
            }
        }
    };

    // Timeline eras with detailed information
    const timelineEras = [
        { 
            id: 'ancient', 
            name: 'Ancient Era', 
            period: '500+ years ago', 
            description: 'The founding of the first settlements',
            className: 'era-ancient'
        },
        { 
            id: 'war', 
            name: 'War Period', 
            period: '200-100 years ago', 
            description: 'The Great Kingdom Wars ravage the land',
            className: 'era-war'
        },
        { 
            id: 'peace', 
            name: 'Peace Treaties', 
            period: '100-50 years ago', 
            description: 'First diplomatic relations established',
            className: 'era-peace'
        },
        { 
            id: 'modern', 
            name: 'Modern Era', 
            period: 'Last 50 years', 
            description: 'Growing cooperation and prosperity',
            className: 'era-modern'
        },
        { 
            id: 'current', 
            name: 'Current Era', 
            period: 'Present day', 
            description: 'The Royal Alliance unites the kingdoms',
            className: 'era-current'
        }
    ];

    // Achievement system
    class AchievementSystem {
        constructor() {
            this.achievements = {
                'first_discovery': { 
                    name: 'First Steps', 
                    description: 'Discovered your first location',
                    icon: '🗺️',
                    unlocked: false 
                },
                'kingdom_explorer': { 
                    name: 'Kingdom Explorer', 
                    description: 'Visited both capital cities',
                    icon: '👑',
                    unlocked: false 
                },
                'time_traveler': { 
                    name: 'Time Traveler', 
                    description: 'Explored all historical eras',
                    icon: '⏰',
                    unlocked: false 
                },
                'scholar': { 
                    name: 'Scholar of Lore', 
                    description: 'Read detailed lore for 5 locations',
                    icon: '📚',
                    unlocked: false 
                },
                'master_explorer': { 
                    name: 'Master Explorer', 
                    description: 'Discovered all locations',
                    icon: '🌟',
                    unlocked: false 
                }
            };
            
            this.discoveredLocations = new Set();
            this.visitedEras = new Set();
            this.readDescriptions = 0;
        }

        checkAchievements() {
            // First discovery
            if (this.discoveredLocations.size >= 1 && !this.achievements.first_discovery.unlocked) {
                this.unlockAchievement('first_discovery');
            }

            // Kingdom explorer
            const capitals = ['Caelforge', 'Solaire'];
            if (capitals.every(cap => this.discoveredLocations.has(cap)) && !this.achievements.kingdom_explorer.unlocked) {
                this.unlockAchievement('kingdom_explorer');
            }

            // Time traveler
            if (this.visitedEras.size >= 3 && !this.achievements.time_traveler.unlocked) {
                this.unlockAchievement('time_traveler');
            }

            // Scholar
            if (this.readDescriptions >= 5 && !this.achievements.scholar.unlocked) {
                this.unlockAchievement('scholar');
            }

            // Master explorer
            if (this.discoveredLocations.size >= Object.keys(kingdomData).length && !this.achievements.master_explorer.unlocked) {
                this.unlockAchievement('master_explorer');
            }
        }

        unlockAchievement(id) {
            this.achievements[id].unlocked = true;
            this.showAchievementNotification(this.achievements[id]);
            this.updateAchievementDisplay();
        }

        showAchievementNotification(achievement) {
            const notification = document.getElementById('achievement-notification');
            const text = document.getElementById('achievement-text');
            
            text.innerHTML = `<strong>${achievement.name}</strong><br><small>${achievement.description}</small>`;
            notification.querySelector('.achievement-icon').textContent = achievement.icon;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        updateAchievementDisplay() {
            const list = document.getElementById('achievement-list');
            list.innerHTML = '';

            Object.entries(this.achievements).forEach(([id, achievement]) => {
                const div = document.createElement('div');
                div.className = 'popup-section';
                div.innerHTML = `
                    <h4 style="color: ${achievement.unlocked ? '#FFD700' : '#888'}">${achievement.icon} ${achievement.name}</h4>
                    <p style="color: ${achievement.unlocked ? '#f4f1e8' : '#aaa'}">${achievement.description}</p>
                    ${achievement.unlocked ? '<small style="color: #D4AF37">✓ Unlocked</small>' : '<small style="color: #666">🔒 Locked</small>'}
                `;
                list.appendChild(div);
            });
        }
    }

    // Weather system
    class WeatherSystem {
        constructor() {
            this.currentWeather = 'clear';
            this.weatherEffects = {
                'snow': { particles: 80, color: '#ffffff', speed: 2 },
                'golden': { particles: 60, color: '#ffd700', speed: 1 },
                'mist': { particles: 40, color: '#e6e6fa', speed: 0.5 },
                'clear': { particles: 30, color: '#87ceeb', speed: 0.3 },
                'variable': { particles: 50, color: '#dda0dd', speed: 1.5 }
            };
        }

        setWeather(weatherType) {
            this.currentWeather = weatherType;
            this.updateParticles();
        }

        updateParticles() {
            const config = this.weatherEffects[this.currentWeather];
            if (window.pJSDom && window.pJSDom[0]) {
                window.pJSDom[0].pJS.particles.number.value = config.particles;
                window.pJSDom[0].pJS.particles.color.value = config.color;
                window.pJSDom[0].pJS.particles.move.speed = config.speed;
                window.pJSDom[0].pJS.fn.particlesRefresh();
            }
        }
    }

    // Initialize systems
    let map, markersLayer, achievementSystem, weatherSystem;
    let currentEra = 4; // Current Era
    let discoveredLocations = new Set();
    let relationshipLines = [];

    function initializeMap() {
        // Create map with custom coordinate system
        map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -1,
            maxZoom: 2,
            zoomControl: true,
            attributionControl: false,
            preferCanvas: true,
            tap: true,
            tapTolerance: 15
        });

        // Set the map bounds
        const bounds = [[0, 0], [1000, 800]];
        const imageUrl = './kingdoms-map.jpg';

        // Add the map image overlay
        L.imageOverlay(imageUrl, bounds).addTo(map);
        
        // Set initial view optimized for mobile
        map.fitBounds(bounds);
        map.setView([500, 400], 0);

        // Initialize systems
        achievementSystem = new AchievementSystem();
        weatherSystem = new WeatherSystem();

        // Create markers layer
        markersLayer = L.layerGroup().addTo(map);
        
        // Add enhanced markers
        addEnhancedMarkers();
        
        // Setup enhanced search
        setupEnhancedSearch();
        
        // Setup tab system
        setupTabSystem();
        
        // Setup timeline
        setupTimeline();
        
        // Initialize particles
        initializeParticles();
        
        // Show initial achievements
        achievementSystem.updateAchievementDisplay();
        
        // Hide loading overlay
        setTimeout(() => {
            document.getElementById('loadingOverlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loadingOverlay').style.display = 'none';
            }, 800);
        }, 2000);
    }

    function addEnhancedMarkers() {
        Object.entries(kingdomData).forEach(([name, data]) => {
            let markerClass = 'custom-marker';
            let markerIcon = '●';
            
            // Add era classes for each location
            const eraClasses = [];
            Object.keys(data.eras).forEach(era => {
                if (data.eras[era].existed) {
                    eraClasses.push(`${era}-era`);
                }
            });
            
            if (data.kingdom === 'Aurenne') {
                markerClass += ' aurenne-marker';
                markerIcon = data.type === 'Capital' ? '♔' : '⚜️';
            } else if (data.kingdom === 'Daeryndor') {
                markerClass += ' daeryndor-marker';
                markerIcon = data.type === 'Capital' ? '♔' : '⛰️';
            } else if (data.kingdom === 'Border Region') {
                markerClass += ' border-marker';
                markerIcon = '⚖️';
            }

            markerClass += ' ' + eraClasses.join(' ');

            const markerElement = L.divIcon({
                className: markerClass,
                html: markerIcon,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
            });

            const marker = L.marker(data.coords, { icon: markerElement })
                .bindPopup(createEnhancedPopup(name, data), {
                    maxWidth: 300,
                    className: 'enhanced-popup'
                });

            marker.on('click', () => {
                discoverLocation(name, data);
                weatherSystem.setWeather(data.weather);
            });
            
            markersLayer.addLayer(marker);
        });

        // Add relationship lines
        drawRelationshipLines();
    }

    function createEnhancedPopup(name, data) {
        const currentEraInfo = data.eras[timelineEras[currentEra].id];
        const eraName = currentEraInfo ? currentEraInfo.name : name;
        const eraDesc = currentEraInfo ? currentEraInfo.description : data.description;
        
        return `
            <div class="popup-header">${eraName}</div>
            
            <div class="popup-section">
                <h4>📍 Era</h4>
                <p>${timelineEras[currentEra].name} - ${timelineEras[currentEra].period}</p>
            </div>

            <div class="popup-section">
                <h4>👑 ${currentEra === 4 ? 'Current Ruler' : 'Status'}</h4>
                <p>${currentEra === 4 ? data.ruler : eraDesc}</p>
            </div>

            ${currentEra === 4 ? `
            <div class="popup-section">
                <h4>🏛️ Kingdom</h4>
                <p>${data.kingdom} • Pop: ${data.population}</p>
            </div>` : ''}

            <div style="text-align: center; margin-top: 12px;">
                <button class="expand-btn" onclick="expandLocationDetails('${name}')">
                    📚 Learn More
                </button>
                <button class="action-btn" onclick="focusLocation('${name}')">
                    🔍 Center
                </button>
            </div>
        `;
    }

    function discoverLocation(name, data) {
        if (!discoveredLocations.has(name)) {
            discoveredLocations.add(name);
            achievementSystem.discoveredLocations.add(name);
            achievementSystem.readDescriptions++;
            achievementSystem.checkAchievements();
            
            // Add discovery glow effect
            const marker = findMarkerByName(name);
            if (marker) {
                marker.getElement().classList.add('discovery-glow');
                setTimeout(() => {
                    marker.getElement().classList.remove('discovery-glow');
                }, 3000);
            }
        }
    }

    function expandLocationDetails(name) {
        const data = kingdomData[name];
        const details = document.getElementById('location-details');
        const currentEraInfo = data.eras[timelineEras[currentEra].id];
        
        let content = `
            <div class="popup-section">
                <h4>🏰 ${name} (${timelineEras[currentEra].name})</h4>
                <p><strong>Status:</strong> ${currentEraInfo ? (currentEraInfo.existed ? currentEraInfo.name : 'Does not exist') : 'Unknown'}</p>
                <p><strong>Description:</strong> ${currentEraInfo ? currentEraInfo.description : 'No information available'}</p>
            </div>
        `;

        if (currentEra === 4) { // Current era - show full details
            content += `
                <div class="popup-section">
                    <h4>📚 Current Lore</h4>
                    <p>${data.lore}</p>
                </div>

                <div class="popup-section">
                    <h4>🏛️ Features</h4>
                    <ul>${data.features.map(f => `<li>${f}</li>`).join('')}</ul>
                </div>

                <div class="popup-section">
                    <h4>🤫 Secrets</h4>
                    <ul>${data.secrets.map(s => `<li><em>${s}</em></li>`).join('')}</ul>
                </div>

                <div class="popup-section">
                    <h4>👥 Characters</h4>
                    <ul>${data.characters.map(c => `<li>${c}</li>`).join('')}</ul>
                </div>
            `;
        }
        
        details.innerHTML = content;
        switchTab('lore');
    }

    function drawRelationshipLines() {
        const connections = [
            { from: 'Caelforge', to: 'Ironroud', type: 'alliance' },
            { from: 'Solaire', to: 'Lucastel', type: 'trade' },
            { from: 'Caelforge', to: 'Frosthaven', type: 'supply' },
            { from: 'Storeward', to: 'Caelforge', type: 'neutral' },
            { from: 'Storeward', to: 'Solaire', type: 'neutral' }
        ];

        connections.forEach(conn => {
            const fromData = kingdomData[conn.from];
            const toData = kingdomData[conn.to];
            
            if (fromData && toData) {
                const line = L.polyline([fromData.coords, toData.coords], {
                    color: getRelationshipColor(conn.type),
                    weight: 4,
                    opacity: 0.7,
                    dashArray: '8, 4',
                    className: 'relationship-line'
                }).bindTooltip(`${conn.type}: ${conn.from} ↔ ${conn.to}`);
                
                relationshipLines.push(line);
                line.addTo(map);
            }
        });
    }

    function getRelationshipColor(type) {
        const colors = {
            'alliance': '#4CAF50',
            'trade': '#FF9800',
            'supply': '#2196F3',
            'neutral': '#9E9E9E',
            'scholarly': '#9C27B0'
        };
        return colors[type] || '#666666';
    }

    function setupEnhancedSearch() {
        const searchInput = document.getElementById('searchInput');
        
        searchInput.addEventListener('input', debounce(function(e) {
            const query = e.target.value.toLowerCase();
            
            if (query.length < 2) return;
            
            const matches = Object.keys(kingdomData).filter(name => {
                const data = kingdomData[name];
                return name.toLowerCase().includes(query) ||
                       data.kingdom.toLowerCase().includes(query) ||
                       data.ruler.toLowerCase().includes(query) ||
                       data.description.toLowerCase().includes(query);
            });
            
            if (matches.length > 0) {
                const firstMatch = matches[0];
                const coords = kingdomData[firstMatch].coords;
                map.setView(coords, 1);
                
                const marker = findMarkerByName(firstMatch);
                if (marker) {
                    marker.openPopup();
                    discoverLocation(firstMatch, kingdomData[firstMatch]);
                }
            }
        }, 300));
    }

    function setupTabSystem() {
        const tabs = document.querySelectorAll('.panel-tab');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;
                switchTab(targetTab);
            });
        });
    }

    function switchTab(targetTab) {
        document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.panel-content').forEach(c => c.classList.remove('active'));
        
        document.querySelector(`[data-tab="${targetTab}"]`).classList.add('active');
        document.getElementById(`${targetTab}-content`).classList.add('active');
    }

    function setupTimeline() {
        const slider = document.getElementById('timeline-slider');
        const handle = document.getElementById('timeline-handle');
        const label = document.getElementById('timeline-label');
        const description = document.getElementById('era-description');
        
        let isDragging = false;
        
        function updateTimeline(percentage) {
            const eraIndex = Math.floor(percentage * timelineEras.length);
            const clampedIndex = Math.max(0, Math.min(eraIndex, timelineEras.length - 1));
            
            currentEra = clampedIndex;
            const era = timelineEras[clampedIndex];
            
            handle.style.left = `${(clampedIndex / (timelineEras.length - 1)) * (slider.offsetWidth - 20)}px`;
            label.textContent = era.name;
            description.textContent = era.description;
            
            // Track visited eras for achievements
            achievementSystem.visitedEras.add(era.id);
            achievementSystem.checkAchievements();
            
            // Update map appearance based on era
            updateMapForEra(era);
        }
        
        // Touch and click events
        slider.addEventListener('touchstart', handleStart);
        slider.addEventListener('mousedown', handleStart);
        
        function handleStart(e) {
            e.preventDefault();
            const rect = slider.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const percentage = (clientX - rect.left) / rect.width;
            updateTimeline(percentage);
            isDragging = true;
        }
        
        document.addEventListener('touchmove', handleMove);
        document.addEventListener('mousemove', handleMove);
        
        function handleMove(e) {
            if (!isDragging) return;
            e.preventDefault();
            const rect = slider.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const percentage = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
            updateTimeline(percentage);
        }
        
        document.addEventListener('touchend', () => isDragging = false);
        document.addEventListener('mouseup', () => isDragging = false);
        
        // Initialize timeline
        updateTimeline(1); // Start at current era
    }

    function updateMapForEra(era) {
        // Remove all era classes from map
        const mapContainer = map.getContainer();
        mapContainer.className = mapContainer.className.replace(/era-\w+/g, '');
        
        // Add current era class
        mapContainer.classList.add(era.className);
        
        // Update all markers and popups based on era
        markersLayer.eachLayer(layer => {
            layer.closePopup();
        });
    }

    function initializeParticles() {
        particlesJS('particles-js', {
            particles: {
                number: { value: 60 },
                color: { value: ['#ffd700', '#daa520', '#87ceeb'] },
                shape: { type: 'circle' },
                opacity: { value: 0.5, random: true },
                size: { value: 2, random: true },
                move: {
                    enable: true,
                    speed: 1,
                    direction: 'top-right',
                    random: true,
                    out_mode: 'out'
                }
            },
            interactivity: {
                detect_on: 'window',
                events: {
                    onhover: { enable: false },
                    onclick: { enable: true, mode: 'push' }
                }
            },
            retina_detect: true
        });
    }

    function focusLocation(locationName) {
        const data = kingdomData[locationName];
        if (data) {
            map.setView(data.coords, 1);
            discoverLocation(locationName, data);
        }
    }

    function findMarkerByName(name) {
        let foundMarker = null;
        markersLayer.eachLayer(layer => {
            if (layer.getPopup() && layer.getPopup().getContent().includes(name)) {
                foundMarker = layer;
            }
        });
        return foundMarker;
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Handle window resize
    window.addEventListener('resize', debounce(function() {
        if (map) {
            map.invalidateSize();
        }
    }, 250));

    // Initialize map when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initializeMap();
    });

    // Make functions globally available
    window.expandLocationDetails = expandLocationDetails;
    window.focusLocation = focusLocation;
    window.switchTab = switchTab;
</script>
```

</body>
</html>
